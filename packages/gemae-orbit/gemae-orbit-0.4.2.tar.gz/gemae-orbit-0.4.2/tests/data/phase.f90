PROGRAM PHASE

USE precision, WP => DP
implicit none
!A PARTIR DEL TIEMPO DE OBSERVACION t (Y SABIENDO T[TIEMPO DE PASAJE POR EL PERIASTRO],P[PERIODO],e[EXENTRICIDAD], HJD)
!PUEDO CALCULAR LA ANOMALIA EXCENTRICA Y CON ESTA LA VERDADERA QUE ES EL THETA QUE NECESITO COMO FASE DE LA ORBITA PARA 
!EN LA ENCUACION DE LA CURVA Y SACAR LAS VELOCIDADES RADIALES PARA LAS OBSERVACIONES

REAL(WP):: HJD,EN,THETA,vr1,vr2           !DELTA:TOLERANCIA, EA: ANOMALIA EXENTRICA
INTEGER :: I             
CHARACTER*39 :: NAME



OPEN(11,FILE='HJD.d')
OPEN(12,FILE='PHASE.d')
OPEN(13,FILE='VRTeo(jordi).d')

WRITE(12,*)'NAME                    ', 'HJD          ','         EXENTRIC ANOMALY  ','  THETA  ','VR1','VR2'


DO I=1,11
    READ(11,*)NAME, HJD
    HJD=HJD-245.d4
    !write(*,*)HJD,245.d4
    CALL ETHETA(HJD,EN,THETA)
    CALL VR(THETA,VR1,VR2)
    WRITE(12,*)NAME,HJD,EN,THETA,VR1,VR2
    write(13,*)NAME,VR1,VR2

ENDDO


CLOSE(11)
CLOSE(12)

END

SUBROUTINE ETHETA(HJD,EN,THETA)
use precision, WP=>DP
implicit none
REAL(WP):: PHASS,E,D,EN,EN_1,HJD,T,P,PI,THETA,du
LOGICAL :: NONCONV

PI=4.d0*dATAN(1.d0)
T=5608.19   !TIEMPO DE PASAJE POR PERIASTRO
P=29.1321  !PERIODO
E=.764    !EXCENTRICIDAD
EN_1=.5  !ESTIMACION INICIAL
D=1.D-4  !TOLERANCIA
NONCONV=.TRUE.


PHASS=2.D0*PI*(((HJD-T)/P)-int((HJD-T)/P)) !HJD,t y p en las mismas unidades
!write(*,*)((((HJD-T)/P)-int((HJD-T)/P))*2.d0*PI)-PHASS
DO WHILE (NONCONV)
    EN=PHASS+E*SIN(EN_1)
    IF (ABS(EN-EN_1)<D) THEN
        NONCONV=.FALSE.
    ELSE
        EN_1=EN
    ENDIF
ENDDO

du=DSQRT((1.D0+E)/(1.D0-E))
!write(*,*)du
THETA=2.D0*DATAN(du*DTAN(EN/2.D0))
write(*,*)phass/(PI*2.),en*360./(PI*2.),theta*360./(PI*2.)
RETURN
END

SUBROUTINE VR(T,V1,V2)
USE precision, WP => DP
IMPLICIT none
REAL(wp) :: T,V1,V2,K1,K2,E,w,G,PI

PI=4.d0*dATAN(1.d0)

K1=118.d0
K2=221.d0
W=126.*2*pi/360.
E=0.76
G=28
V1=(K1*COS(T+W)+E*COS(W))+G
V2=(K2*COS(T+W)+E*COS(W))+G
RETURN
END